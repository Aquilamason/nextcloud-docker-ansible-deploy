[Unit]
Description=Nextcloud S3fs external storage
After=docker.service
Requires=docker.service

[Service]
Type=simple
ExecStartPre=-/usr/bin/docker kill %n
ExecStartPre=-/usr/bin/docker rm %n
ExecStartPre=-/usr/bin/mkdir /tmp/nextcloud-s3fs-cache
ExecStart=/usr/bin/docker run --rm --name %n \
				-v {{ nextcloud_base_data_path }}/s3fs-credentials:/s3fs-credentials \
				--security-opt apparmor:unconfined \
				--cap-add mknod \
				--cap-add sys_admin \
				--device=/dev/fuse \
				-v {{ nextcloud_s3fs_external_storage_path }}:/s3fs-external-storage:shared \
				-v /tmp/nextcloud-s3fs-cache:/s3fs-cache \
				{{ nextcloud_docker_image_s3fs }} \
				/usr/bin/s3fs -f \
					-o allow_other \
					-o use_cache=/s3fs-cache \
					-o storage_class=standard_ia \
					-o passwd_file=/s3fs-credentials \
					{{ nextcloud_s3fs_external_storage_bucket_name }} /s3fs-external-storage
TimeoutStartSec=5min
ExecStop=-/usr/bin/docker stop %n
ExecStop=-/usr/bin/docker kill %n
ExecStop=-/usr/bin/docker rm %n
ExecStop=-/usr/bin/rm -rf /tmp/nextcloud-s3fs-cache
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
